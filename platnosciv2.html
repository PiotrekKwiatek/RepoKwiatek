<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Płatność składki z QR kodem (PSR)</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 400px; margin: 20px auto; }
  label { display: block; margin-top: 15px; }
  select, input { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
  button { margin-top: 20px; padding: 10px; width: 100%; font-size: 16px; }
  #wynik { margin-top: 20px; padding: 15px; border: 1px solid #ccc; background: #f9f9f9; white-space: pre-wrap; }
  #qrcode { margin-top: 20px; text-align: center; }
</style>
</head>
<body>

<h1>Opłać składkę</h1>

<label>Cel wpłaty:
  <select id="cel">
    <option value="Składka maj 2025|50.00">Składka maj 2025 – 50 zł</option>
    <option value="Biwak wiosenny|120.00">Biwak wiosenny – 120 zł</option>
    <option value="Obóz letni|950.00">Obóz letni – 950 zł</option>
  </select>
</label>

<label>Imię i nazwisko:
  <input type="text" id="nazwisko" placeholder="Jan Kowalski" />
</label>

<button onclick="generuj()">Generuj dane i QR kod</button>

<div id="wynik"></div>
<div id="qrcode"></div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const nrKonta = "PL63109019260000000514000254"; // Podmień na swój IBAN bez spacji
const nazwaOdbiorcy = "Twoja Organizacja";     // Podmień na swoją nazwę

function formatAmount(amount) {
  return amount.replace('.', ',');
}

// Funkcja tworząca tekst do PSR QR (w formacie ISO 20022, uproszczonym):
function generatePSR(iban, name, amount, title) {
  amount = formatAmount(amount);

  // Składnia PSR QR (z uproszczeniem, wymagania: https://standardqr.pl/)
  // Kodowanie polskie znaki zastępujemy najprościej:
  title = title.normalize('NFD').replace(/[\u0300-\u036f]/g, ''); 

  return [
    "BCD",
    "001",
    "1",
    "SCT",
    "Santander Bank Polska", // bank
    iban.replace('PL',''),
    name,
    "PL",
    amount,
    "",
    title
  ].join("\n");
}

function generuj() {
  const wynikEl = document.getElementById("wynik");
  const qrcodeEl = document.getElementById("qrcode");
  wynikEl.textContent = "";
  qrcodeEl.innerHTML = "";

  const cel = document.getElementById("cel").value;
  const [tytul, kwota] = cel.split("|");
  const nazwiskoRaw = document.getElementById("nazwisko").value.trim();

  if (!nazwiskoRaw) {
    alert("Proszę wpisać imię i nazwisko.");
    return;
  }

  const tytulPelny = `${tytul} - ${nazwiskoRaw}`;

  wynikEl.textContent =
    `Numer konta: ${nrKonta}\n` +
    `Kwota: ${kwota} zł\n` +
    `Tytuł przelewu: ${tytulPelny}`;

  const psrText = generatePSR(nrKonta, nazwaOdbiorcy, kwota, tytulPelny);

  QRCode.toCanvas(qrcodeEl, psrText, { width: 220 }, function (error) {
    if (error) console.error(error);
  });
}
</script>

</body>
</html>
